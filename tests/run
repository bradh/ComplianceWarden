#!/usr/bin/env bash
set -euo pipefail

readonly BIN=$1
readonly scriptDir=$(dirname $0)

readonly tmpDir=/tmp/test-cw-$$
trap "rm -rf $tmpDir" EXIT
mkdir -p "$tmpDir"

function main
{
  run_test real_mp4

  run_test check_rules_folder dummy
  run_test check_rules_folder heif
  run_test check_rules_folder miaf

  echo "OK"
}

function run_test
{
  echo "* $*"
  "$@"
}

function real_mp4
{
  $BIN/cw.exe dummy $scriptDir/aac.mp4 > $tmpDir/aac.new
  compare $scriptDir/aac.ref $tmpDir/aac.new
}

function check_rules
{
  local spec="$1"
  local name="$2"
  local mp4path="$tmpDir/$name.mp4"
  mkdir -p $(dirname $mp4path)
  nasm $scriptDir/$name.asm -f bin -o $mp4path
  $BIN/cw.exe $spec $tmpDir/$name.mp4 > $tmpDir/$name.new
  compare $scriptDir/$name.ref $tmpDir/$name.new
}

function check_rules_folder
{
  local folder="$1"
  for i in `ls $scriptDir/$folder/*.asm` ; do
    local name=`basename ${i%.*}`
    run_test check_rules $folder "$folder/$name"
  done
}

function compare
{
  local ref=$1
  local new=$2

  # cp "$new" "$ref"
  diff -Naur "$ref" "$new"
}

main "$@"
