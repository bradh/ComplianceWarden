#!/usr/bin/env bash
set -euo pipefail

readonly BIN=$1
readonly scriptDir=$(dirname $0)

readonly tmpDir=/tmp/test-cw-$$
trap "rm -rf $tmpDir" EXIT
mkdir -p "$tmpDir"

function main
{
  $BIN/cw.exe $scriptDir/aac.mp4 > $tmpDir/aac.new
  compare $scriptDir/aac.ref $tmpDir/aac.new

  check_rules dummy_no_ftyp

  $BIN/binarize.exe < $scriptDir/binarize_me.txt > $tmpDir/binarized.bin
  compare $scriptDir/binarized.ref $tmpDir/binarized.bin

  echo "OK"
}

function check_rules
{
  local name="$1"
  nasm $scriptDir/$name.asm -f bin -o $tmpDir/$name.mp4
  $BIN/cw.exe $tmpDir/$name.mp4 > $tmpDir/$name.new
  compare $scriptDir/$name.ref $tmpDir/$name.new
}

function compare
{
  local ref=$1
  local new=$2

  # cp "$new" "$ref"
  diff -Naur "$ref" "$new"
}

main "$@"
